<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Google‑Lens — Polished Image Finder</title>
  <meta name="description" content="Run ORB-based image similarity locally in your browser using OpenCV.js. Auto-detects matches, shows top results, preview and keyboard navigation." />

  <style>
    :root{
      --glass: rgba(255,255,255,0.10);
      --accent1: #ff6b6b;
      --accent2: #ffd166;
      --accent3: #6a11cb; /* deep purple */
      --text: #ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial}

    /* Animated radiant background */
    body{
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;padding:28px;
      background: linear-gradient(120deg, #0f2027 0%, #203a43 35%, #2c5364 100%);
      overflow:auto;
    }

    .card{
      width:100%;max-width:1150px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:18px;padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 40px rgba(3,3,3,0.6);
    }

    header{display:flex;gap:16px;align-items:center;margin-bottom:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent3),#2ec4b6);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
    h1{font-size:20px;color:var(--text);margin:0}
    p.lead{margin:0;color:rgba(255,255,255,0.75);font-size:13px}

    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .control-card{background:var(--glass);padding:12px;border-radius:12px;flex:1;min-width:260px;border:1px solid rgba(255,255,255,0.03)}

    label{display:block;color:var(--text);font-weight:700;margin-bottom:6px}
    input[type=file]{width:100%;padding:8px;border-radius:10px;border:0;background:rgba(255,255,255,0.06);color:var(--text)}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#111;font-weight:800;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}

    .main{display:flex;gap:18px;margin-top:18px}
    .left{width:420px}
    .right{flex:1}

    .preview{background:rgba(0,0,0,0.35);border-radius:12px;padding:12px;height:420px;display:flex;flex-direction:column;gap:12px}
    .preview .image-wrap{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .preview img{max-width:100%;max-height:100%;object-fit:contain}
    .preview .meta{display:flex;justify-content:space-between;align-items:center}

    .results-area{background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;height:420px;overflow:auto}
    .result-row{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;transition:transform .12s;cursor:pointer}
    .result-row:hover{transform:translateY(-4px)}
    .thumb{width:72px;height:72px;border-radius:8px;background:#eee;overflow:hidden;flex-shrink:0}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .result-meta{flex:1;color:rgba(255,255,255,0.9)}
    .score{font-weight:800;color:var(--accent2)}

    .toolbar{display:flex;gap:10px;align-items:center}
    .slider{width:200px}
    .progress{height:10px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent1));width:0%}

    footer{margin-top:16px;color:rgba(255,255,255,0.6);font-size:13px}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal img{max-width:90vw;max-height:90vh;border-radius:8px}

    @media (max-width:980px){.main{flex-direction:column}.left{width:100%}.preview{height:320px}.results-area{height:320px}}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div class="logo">GL</div>
      <div>
        <h1>Local Google‑Lens — Polished</h1>
        <p class="lead">Search images on your PC (fully local). Auto-detect similar images, preview, keyboard navigation & fast indexing.</p>
      </div>
    </header>

    <div class="controls">
      <div class="control-card">
        <label>Query Image (or drag & drop)</label>
        <input id="queryFile" type="file" accept="image/*">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="clearQuery" class="btn secondary">Clear</button>
          <button id="previewQuery" class="btn secondary">Open Query</button>
        </div>
      </div>

      <div class="control-card">
        <label>Select Folder / Files (Chrome/Edge support folder picking)</label>
        <input id="folderInput" type="file" accept="image/*" webkitdirectory directory multiple>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="indexBtn" class="btn">Index Folder</button>
          <button id="autoBtn" class="btn">Auto‑Detect on Index</button>
        </div>
        <div style="margin-top:10px; color:rgba(255,255,255,0.7); font-size:13px">Indexed images: <span id="indexedCount">0</span></div>
      </div>

      <div class="control-card">
        <label>Matching Controls</label>
        <div class="toolbar">
          <div>Threshold: <strong id="thVal">0.2</strong></div>
          <input id="threshold" class="slider" type="range" min="0" max="1" step="0.01" value="0.20">
        </div>
        <div style="height:8px;margin-top:8px" class="progress"><i id="progressBar"></i></div>
        <div style="margin-top:10px;color:rgba(255,255,255,0.75)">Top results: <strong id="topN">10</strong></div>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="preview">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <div style="font-weight:800">Query</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.7)" id="queryName">No file</div>
          </div>

          <div class="image-wrap" id="queryPreview">Drop an image or choose one</div>

          <div class="meta"><div id="queryInfo"></div><div><button id="openModalBtn" class="btn secondary">Zoom</button></div></div>
        </div>
      </div>

      <div class="right">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800;color:var(--text)">Similar Results</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevBtn" class="btn secondary">Prev</button>
            <button id="nextBtn" class="btn secondary">Next</button>
            <button id="reRunBtn" class="btn">Re-run Match</button>
          </div>
        </div>

        <div class="results-area" id="resultsList"></div>
      </div>
    </div>

    <footer>Runs fully in your browser — images never leave your machine. Use Arrow keys to navigate results; Enter to zoom selected.</footer>
  </div>

  <div class="modal" id="modal"><img id="modalImg"><button id="closeModal" style="position:absolute;top:24px;right:24px;padding:10px 12px;border-radius:8px;border:none;">Close</button></div>

  <!-- OpenCV.js (primary + fallback) -->
  <script>
    const OPENCV_URLS = [
      'https://docs.opencv.org/4.x/opencv.js',
      'https://cdn.jsdelivr.net/npm/opencv@4.7.0/opencv.js'
    ];

    function loadScript(src){
      return new Promise((res, rej)=>{
        const s = document.createElement('script'); s.src = src; s.async = true;
        s.onload = ()=>res(src); s.onerror = ()=>rej(src);
        document.head.appendChild(s);
      });
    }

    async function ensureOpenCv(){
      for (let url of OPENCV_URLS){
        try{ await loadScript(url); if(window.cv){
          if(cv['onRuntimeInitialized']){
            await new Promise(r=>{cv['onRuntimeInitialized']=r});
          }
          console.log('OpenCV ready from', url); return true; }
        } catch(e){ console.warn('Failed to load', url); }
      }
      return false;
    }
  </script>

  <script>
    // App logic
    (async function(){
      const ok = await ensureOpenCv();
      if(!ok){ alert('OpenCV failed to load. Check console.'); return; }

      // UI elements
      const qFile = document.getElementById('queryFile');
      const folderInput = document.getElementById('folderInput');
      const indexBtn = document.getElementById('indexBtn');
      const autoBtn = document.getElementById('autoBtn');
      const clearQuery = document.getElementById('clearQuery');
      const previewQuery = document.getElementById('previewQuery');
      const queryPreview = document.getElementById('queryPreview');
      const queryName = document.getElementById('queryName');
      const queryInfo = document.getElementById('queryInfo');
      const indexedCount = document.getElementById('indexedCount');
      const threshold = document.getElementById('threshold');
      const thVal = document.getElementById('thVal');
      const progressBar = document.getElementById('progressBar');
      const resultsList = document.getElementById('resultsList');
      const searchBtn = document.getElementById('reRunBtn');
      const indexImagesBtn = document.getElementById('indexBtn');
      const autoDetectBtn = document.getElementById('autoBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const openModalBtn = document.getElementById('openModalBtn');
      const modal = document.getElementById('modal');
      const modalImg = document.getElementById('modalImg');
      const closeModal = document.getElementById('closeModal');

      let queryFileObj = null;
      let indexedFiles = []; // {file, desc}
      let results = [];
      let selectedIndex = 0;
      let autoDetect = false;

      // helper: read file to Image
      function readAsImage(file){
        return new Promise((res,rej)=>{
          const url = URL.createObjectURL(file);
          const img = new Image(); img.onload = ()=>{ URL.revokeObjectURL(url); res(img); }; img.onerror=rej; img.src = url;
        });
      }

      function setProgress(p){ progressBar.style.width = (p*100)+'%'; }

      function preview(file, target){
        const url = URL.createObjectURL(file);
        target.innerHTML = `<img src="${url}" />`;
      }

      qFile.addEventListener('change', async (e)=>{
        if(!e.target.files[0]) return;
        queryFileObj = e.target.files[0];
        queryName.textContent = queryFileObj.name;
        preview(queryFileObj, queryPreview);
        const img = await readAsImage(queryFileObj);
        queryInfo.textContent = `${img.width} x ${img.height}`;
      });

      clearQuery.addEventListener('click', ()=>{ queryFileObj=null; queryPreview.innerHTML='Drop an image or choose one'; queryName.textContent='No file'; queryInfo.textContent=''; });

      // drag & drop support on queryPreview
      ['dragenter','dragover'].forEach(ev=>{ queryPreview.addEventListener(ev,e=>{ e.preventDefault(); queryPreview.style.outline='3px dashed rgba(255,255,255,0.12)'; }); });
      ['dragleave','drop'].forEach(ev=>{ queryPreview.addEventListener(ev,e=>{ e.preventDefault(); queryPreview.style.outline='none'; }); });
      queryPreview.addEventListener('drop', async (e)=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return; qFile.files = e.dataTransfer.files; qFile.dispatchEvent(new Event('change'));
      });

      // indexing folder
      folderInput.addEventListener('change', (e)=>{ indexedFiles = []; const files = Array.from(e.target.files || []).filter(f=>/\.(jpe?g|png|bmp|gif)$/i.test(f.name)); indexedFiles = files.map(f=>({file:f, desc:null})); indexedCount.textContent = indexedFiles.length; });

      indexImagesBtn.addEventListener('click', async ()=>{
        if(indexedFiles.length===0){ alert('No images selected to index'); return; }
        setProgress(0);
        const orb = new cv.ORB();
        for(let i=0;i<indexedFiles.length;i++){
          const it = indexedFiles[i];
          try{
            const img = await readAsImage(it.file);
            const mat = cv.imread(imgToCanvas(img));
            const gray = new cv.Mat(); cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
            const kp = new cv.KeyPointVector(); const desc = new cv.Mat(); orb.detectAndCompute(gray, new cv.Mat(), kp, desc);
            it.desc = {kp, desc};
            mat.delete(); gray.delete();
          }catch(e){ console.warn('index err', e); }
          setProgress((i+1)/indexedFiles.length);
          await new Promise(r=>setTimeout(r,10));
        }
        orb.delete();
        alert('Indexing completed');
      });

      autoDetectBtn.addEventListener('click', ()=>{ autoDetect = !autoDetect; autoDetectBtn.textContent = autoDetect? 'Auto‑Detect ON':'Auto‑Detect OFF'; if(autoDetect && queryFileObj && indexedFiles.length>0){ runMatch(); } });

      threshold.addEventListener('input', ()=>{ thVal.textContent = threshold.value; });

      // helper: image -> canvas element
      function imgToCanvas(img){ const c = document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); return c; }

      // compute descriptors for query (returns desc Mat)
      async function computeDescFromFile(file){ const img = await readAsImage(file); const mat = cv.imread(imgToCanvas(img)); const gray = new cv.Mat(); cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY); const orb = new cv.ORB(); const kp = new cv.KeyPointVector(); const desc = new cv.Mat(); orb.detectAndCompute(gray, new cv.Mat(), kp, desc); mat.delete(); gray.delete(); orb.delete(); kp.delete(); return desc; }

      // BFMatcher and scoring
      function computeScore(desc1, desc2){ try{ if(!desc1 || desc1.empty() || !desc2 || desc2.empty()) return 0; const bf = new cv.BFMatcher(cv.NORM_HAMMING, true); const matches = new cv.DMatchVector(); bf.match(desc1, desc2, matches); let total=0; for(let i=0;i<matches.size();i++){ const m = matches.get(i); total += Math.max(0,1 - (m.distance/100)); } bf.delete(); matches.delete(); return total;}catch(e){ console.warn('score err', e); return 0; } }

      async function runMatch(){
        if(!queryFileObj){ alert('Select query image'); return; }
        if(indexedFiles.length===0){ alert('Index folder first or add files'); return; }

        // compute query desc
        const qDesc = await computeDescFromFile(queryFileObj);
        results = [];
        setProgress(0);

        for(let i=0;i<indexedFiles.length;i++){
          const it = indexedFiles[i];
          let desc = it.desc ? it.desc.desc : null;
          if(!desc){ // compute on the fly
            desc = await computeDescFromFile(it.file);
          }
          const s = computeScore(qDesc, desc);
          results.push({file:it.file, score:s});
          setProgress((i+1)/indexedFiles.length);
          await new Promise(r=>setTimeout(r,8));
        }
        qDesc.delete();
        results.sort((a,b)=>b.score-a.score);
        renderResults();
      }

      function renderResults(){ resultsList.innerHTML=''; const top = parseInt(document.getElementById('topN').textContent||10,10); const filtered = results.filter(r=>r.score >= parseFloat(threshold.value)).slice(0, top);
        if(filtered.length===0){ resultsList.innerHTML = '<div style="color:rgba(255,255,255,0.7);padding:12px">No matches above threshold</div>'; return; }
        filtered.forEach((r, idx)=>{
          const row = document.createElement('div'); row.className='result-row';
          const thumb = document.createElement('div'); thumb.className='thumb'; const img = document.createElement('img'); img.src = URL.createObjectURL(r.file); thumb.appendChild(img);
          const meta = document.createElement('div'); meta.className='result-meta'; meta.innerHTML = `<div style="font-weight:800">${r.file.name}</div><div style="margin-top:6px;color:rgba(255,255,255,0.6)">Score: <span class='score'>${r.score.toFixed(3)}</span></div>`;
          row.appendChild(thumb); row.appendChild(meta);
          row.addEventListener('click', ()=>{ openModalWithFile(r.file); selectedIndex = idx; highlightRow(idx); });
          resultsList.appendChild(row);
        });
        // select first by default
        selectedIndex = 0; highlightRow(0);
        if(filtered[0]) openModalWithFile(filtered[0].file);
      }

      function highlightRow(idx){ const rows = Array.from(resultsList.children); rows.forEach((r,i)=> r.style.outline = (i===idx)?'2px solid rgba(255,255,255,0.12)':'' ); }

      function openModalWithFile(file){ modal.classList.add('show'); modalImg.src = URL.createObjectURL(file); }
      closeModal.addEventListener('click', ()=> modal.classList.remove('show'));

      prevBtn.addEventListener('click', ()=>{ if(resultsList.children.length===0) return; selectedIndex = Math.max(0, selectedIndex-1); resultsList.children[selectedIndex].click(); resultsList.children[selectedIndex].scrollIntoView({behavior:'smooth',block:'center'}); });
      nextBtn.addEventListener('click', ()=>{ if(resultsList.children.length===0) return; selectedIndex = Math.min(resultsList.children.length-1, selectedIndex+1); resultsList.children[selectedIndex].click(); resultsList.children[selectedIndex].scrollIntoView({behavior:'smooth',block:'center'}); });

      // re-run match
      searchBtn.addEventListener('click', runMatch);

      // keyboard navigation
      window.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowRight') nextBtn.click();
        if(e.key==='ArrowLeft') prevBtn.click();
        if(e.key==='Enter') { if(modal.classList.contains('show')) modal.classList.remove('show'); else if(resultsList.children[selectedIndex]) resultsList.children[selectedIndex].click(); }
      });

      // auto detect on indexing completion
      indexImagesBtn.addEventListener('click', async ()=>{ await indexImagesBtn.click(); /* handled above */ });

      // wire index button: compute descriptors in memory
      indexImagesBtn.addEventListener('click', async ()=>{
        if(!folderInput.files || folderInput.files.length===0) return alert('Select folder/files first');
        // prepare indexedFiles array
        indexedFiles = Array.from(folderInput.files).filter(f=>/\.(jpe?g|png|bmp|gif)$/i.test(f.name)).map(f=>({file:f, desc:null}));
        indexedCount.textContent = indexedFiles.length;
        // now compute descriptors
        setProgress(0);
        const orb = new cv.ORB();
        for(let i=0;i<indexedFiles.length;i++){
          const it = indexedFiles[i];
          try{
            const img = await readAsImage(it.file);
            const mat = cv.imread(imgToCanvas(img));
            const gray = new cv.Mat(); cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
            const kp = new cv.KeyPointVector(); const desc = new cv.Mat(); orb.detectAndCompute(gray, new cv.Mat(), kp, desc);
            it.desc = {kp, desc}; mat.delete(); gray.delete();
          }catch(e){ console.warn('index err', e); }
          setProgress((i+1)/indexedFiles.length);
          await new Promise(r=>setTimeout(r,8));
        }
        orb.delete();
        statusToast('Index complete');
        if(autoDetect && queryFileObj) runMatch();
      });

      function statusToast(t){ console.log(t); }

      // On load: set defaults
      threshold.value = 0.20; thVal.textContent = threshold.value;

      // Small helper to convert Image to Canvas for cv.imread
      function imgToCanvas(img){ const c = document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); return c; }

      // expose global for debugging
      window.app = { indexedFiles, runMatch };
    })();
  </script>
</body>
</html>
